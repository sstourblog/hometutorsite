<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Search Results</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background: #f5f5f5; }

.card-box {
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 18px;
    background: #fff;
    transition: 0.2s;
}
.card-box:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}
.card-title {
    font-size: 20px;
    font-weight: 700;
    color: #0067c5;
}
.mask {
    color: #666;
    font-weight: 600;
}
.view-btn {
    font-size: 14px;
    padding: 6px 12px;
}
</style>
</head>

<body>

<div class="container mt-4">
    <h3 id="resultTitle" class="mb-4 fw-bold"></h3>

    <div id="results" class="d-flex flex-column gap-3">
        <!-- Results go here -->
    </div>
</div>


<!-- VIEW DETAILS MODAL -->
<div class="modal fade" id="detailsModal">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content p-3">

      <h4 class="fw-bold" id="modalName"></h4>
      <p><b>Mobile:</b> <span id="modalMobile"></span></p>
      <p><b>Email:</b> <span id="modalEmail"></span></p>
      <p><b>Course:</b> <span id="modalCourse"></span></p>
      <p><b>Subject:</b> <span id="modalSubject"></span></p>

    </div>
  </div>
</div>


<script>
// =============== SESSION CHECK ===============
function isSessionValid() {
    const token = localStorage.getItem("session_token");
    const expiry = localStorage.getItem("session_expiry");
    if (!token || !expiry) return false;
    return new Date() < new Date(expiry);
}


// =============== SWEETALERT PASSWORD PROMPT ===============
async function requestPassword() {

    const { value: password } = await Swal.fire({
        title: "Admin Access",
        text: "Enter password to view full details",
        input: "password",
        inputPlaceholder: "Enter admin password",
        confirmButtonText: "Unlock",
        showCancelButton: true,
        icon: "info"
    });

    if (!password) return null;

    // Send to backend
    const res = await fetch("https://sanjayer19.pythonanywhere.com/auth", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({password})
    });

    const data = await res.json();

    if (!data.success) {
        Swal.fire("Invalid", "Wrong password. Try again.", "error");
        return null;
    }

    // Save session
    localStorage.setItem("session_token", data.token);
    localStorage.setItem("session_expiry", data.expires);

    Swal.fire("Access Granted", "You can now view full details", "success");

    return data.token;
}



// =============== VIEW DETAILS BUTTON LOGIC ===============
async function viewDetails(id) {

    let token = null;

    if (!isSessionValid()) {
        token = await requestPassword();
        if (!token) return;
    } else {
        token = localStorage.getItem("session_token");
    }

    // Fetch FULL DATA
    const res = await fetch(`https://sanjayer19.pythonanywhere.com/get?id=${id}&token=${token}`);
    const data = await res.json();

    if (!data.success || data.data.length === 0) {
        Swal.fire("Error", "Unable to fetch details", "error");
        return;
    }

    const u = data.data[0];

    // SweetAlert Details Popup
    Swal.fire({
        title: `<strong>${u.name}</strong>`,
        html: `
            <div style="text-align:left">
                <p><b>Mobile:</b> ${u.mobile_no}</p>
                <p><b>Email:</b> ${u.email}</p>
                <p><b>Course:</b> ${u.course}</p>
                <p><b>Subject:</b> ${u.subject}</p>
            </div>
        `,
        icon: "info",
        confirmButtonText: "Close",
        allowOutsideClick: true
    });
}



// =============== LOAD SEARCH RESULTS ===============
document.addEventListener("DOMContentLoaded", () => {

    const params = new URLSearchParams(window.location.search);
    const type = params.get("type");
    const keyword = (params.get("keyword") || "").toLowerCase();

    const apiURL = `https://sanjayer19.pythonanywhere.com/get?type=${type}`;
    const resultsDiv = document.getElementById("results");
    const title = document.getElementById("resultTitle");

    fetch(apiURL).then(res => res.json()).then(data => {

        const list = data.data || [];

        const filtered = list.filter(r =>
            r.course.toLowerCase().includes(keyword) ||
            r.subject.toLowerCase().includes(keyword)
        );

        title.innerHTML = `Found <b>${filtered.length}</b> Results`;

        filtered.forEach(r => {

            const maskedPhone = "XXXXXX" + r.mobile_no.slice(-4);
            const maskedEmail = r.email.replace(/(.)(.*)(@.*)/,
                 (a, b, c, d) => b + "***" + d);

            const card = document.createElement("div");
            card.className = "card-box";

            card.innerHTML = `
                <div class="row">
                    <div class="col-md-2 text-center">
                        <img src="https://cdn-icons-png.flaticon.com/512/847/847969.png" width="70">
                    </div>

                    <div class="col-md-7">
                        <h5 class="card-title">${r.course} - ${r.subject}</h5>
                        <p><b>Name:</b> ${r.name}</p>
                        <p><b>Mobile:</b> <span>${maskedPhone}</span></p>
                        <p><b>Email:</b> <span>${maskedEmail}</span></p>
                    </div>

                    <div class="col-md-3 text-end d-flex flex-column justify-content-center">
                        <button class="btn btn-primary mb-2" onclick="viewDetails('${r.id}')">VIEW DETAILS</button>
                        <button class="btn btn-success">APPLY</button>
                    </div>
                </div>
            `;

            resultsDiv.appendChild(card);
        });

    }).catch(() => {
        Swal.fire("Error", "Unable to load results", "error");
    });
});
</script>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>
</html>
